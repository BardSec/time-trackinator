{% extends "base.html" %}
{% block title %}Dashboard — Time Trackinator{% endblock %}

{% block content %}
<div class="page-header">
  <h1>Hi, {{ current_user.name or current_user.email.split('@')[0] }}</h1>
  <p class="text-muted" id="live-date"></p>
</div>

{# ── Clock In / Out Card ─────────────────────────────────────── #}
<div class="card clock-card {{ 'clocked-in' if active_entry else 'clocked-out' }}">
  <div class="clock-status">
    {% if active_entry %}
      <span class="status-badge status-in">&#9679; Clocked In</span>
      <p class="mt-1">Since <strong id="clock-in-time"></strong></p>
      <p class="duration" id="session-timer">—</p>
    {% else %}
      <span class="status-badge status-out">&#9675; Clocked Out</span>
      <p class="mt-1 text-muted">Ready to start your shift</p>
    {% endif %}
  </div>

  {% if active_entry %}
    <form method="POST" action="{{ url_for('timeclock.clock_out') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" class="btn-clock btn-clock-out">Clock Out</button>
    </form>
  {% else %}
    <form method="POST" action="{{ url_for('timeclock.clock_in') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" class="btn-clock btn-clock-in">Clock In</button>
    </form>
  {% endif %}
</div>

{# ── Summary Cards ───────────────────────────────────────────── #}
<div class="cards-grid">
  <div class="card">
    <div class="card-label">This Week</div>
    <div class="card-value">{{ weekly_hours | fmt_hours }}</div>
    <div class="card-sub">Mon &ndash; Sun</div>
  </div>

  <div class="card">
    <div class="card-label">Pay Period Hours</div>
    <div class="card-value">{{ pay_period_hours | fmt_hours }}</div>
    <div class="card-sub">
      {% if current_user.pay_period_start %}
        {{ current_user.pay_period_start.strftime('%-m/%-d') }} &ndash; {{ current_user.pay_period_end.strftime('%-m/%-d/%y') }}
      {% else %}
        <a href="{{ url_for('timeclock.settings') }}">Set pay period &rarr;</a>
      {% endif %}
    </div>
  </div>

  {% if current_user.pay_rate %}
  <div class="card">
    <div class="card-label">Pay Accrued</div>
    <div class="card-value">${{ "%.2f" | format(pay_accrued) }}</div>
    <div class="card-sub">${{ "%.2f" | format(current_user.pay_rate) }}/hr &times; {{ pay_period_hours | fmt_hours }}</div>
  </div>
  {% else %}
  <div class="card card-muted">
    <div class="card-label">Pay Rate</div>
    <div class="card-value card-value-sm">Not set</div>
    <div class="card-sub"><a href="{{ url_for('timeclock.settings') }}">Add pay rate &rarr;</a></div>
  </div>
  {% endif %}
</div>

{# ── Time Entries Table ──────────────────────────────────────── #}
<div class="section">
  <div class="section-header">
    <h2>Time Entries</h2>
    <a href="{{ url_for('timeclock.new_entry') }}" class="btn btn-sm btn-primary">+ Add Entry</a>
  </div>

  {% if recent_entries %}
  <div class="table-container">
    <table class="table">
      <thead>
        <tr>
          <th>Date</th>
          <th>In</th>
          <th>Out</th>
          <th>Duration</th>
          <th class="hide-sm">Note</th>
          <th style="width:1%"></th>
        </tr>
      </thead>
      <tbody>
        {% for entry in recent_entries %}
        <tr {% if not entry.clock_out %}class="active-row"{% endif %}>
          <td>{{ entry.clock_in | fmt_date }}</td>
          <td>{{ entry.clock_in | fmt_time }}</td>
          <td>
            {% if entry.clock_out %}
              {{ entry.clock_out | fmt_time }}
            {% else %}
              <span class="badge-active">Active</span>
            {% endif %}
          </td>
          <td>
            {% if entry.clock_out %}{{ entry.duration_display }}{% else %}&mdash;{% endif %}
          </td>
          <td class="hide-sm text-muted">{{ entry.note }}</td>
          <td>
            <div style="display:flex;gap:0.35rem;justify-content:flex-end">
              <a href="{{ url_for('timeclock.edit_entry', entry_id=entry.id) }}" class="btn btn-xs">Edit</a>
              <form method="POST" action="{{ url_for('timeclock.delete_entry', entry_id=entry.id) }}"
                    style="display:inline"
                    onsubmit="return confirm('Delete this time entry?')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-xs btn-danger">Del</button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="empty-state">
    <p>No time entries yet. Use the <strong>Clock In</strong> button to start tracking.</p>
  </div>
  {% endif %}
</div>

<script>
  // Live date/time in header
  function updateHeader() {
    const now = new Date();
    const el = document.getElementById('live-date');
    if (el) el.textContent = now.toLocaleDateString([], {weekday:'long', month:'long', day:'numeric'})
      + ' \u00b7 ' + now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
  }
  updateHeader();
  setInterval(updateHeader, 1000);

  {% if active_entry %}
  // Display clock-in time
  const clockInEl = document.getElementById('clock-in-time');
  if (clockInEl) {
    const d = new Date('{{ active_entry.clock_in.strftime("%Y-%m-%dT%H:%M:%S") }}');
    clockInEl.textContent = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }

  // Live session timer
  const clockInMs = new Date('{{ active_entry.clock_in.strftime("%Y-%m-%dT%H:%M:%S") }}').getTime();
  function updateTimer() {
    const diff = Math.floor((Date.now() - clockInMs) / 1000);
    const h = Math.floor(diff / 3600);
    const m = Math.floor((diff % 3600) / 60);
    const s = diff % 60;
    const el = document.getElementById('session-timer');
    if (el) el.textContent = h + 'h ' + String(m).padStart(2,'0') + 'm ' + String(s).padStart(2,'0') + 's';
  }
  updateTimer();
  setInterval(updateTimer, 1000);
  {% endif %}
</script>
{% endblock %}
