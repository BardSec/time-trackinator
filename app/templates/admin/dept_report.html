{% extends "base.html" %}
{% block title %}Department Report — Admin{% endblock %}

{% block content %}
<div class="page-header">
  <a href="{{ url_for('admin.dashboard') }}" class="back-link">&larr; Back to Admin</a>
  <h1>Department Report</h1>
</div>

{# ── Date Range Filter ───────────────────────────────────────── #}
<form method="GET" class="filter-bar">
  <div class="form-group">
    <label class="form-label" for="start">From</label>
    <input type="date" class="form-control" id="start" name="start" value="{{ start_str }}">
  </div>
  <div class="form-group">
    <label class="form-label" for="end">To</label>
    <input type="date" class="form-control" id="end" name="end" value="{{ end_str }}">
  </div>
  <button type="submit" class="btn btn-primary">Run Report</button>
  {% if start_str or end_str %}
    <a href="{{ url_for('admin.dept_report') }}" class="btn">Clear</a>
  {% endif %}
</form>

{# ── Department Total ────────────────────────────────────────── #}
<div class="stats-row" style="margin-bottom:1.25rem">
  <div class="stat-card">
    <div class="stat-value">{{ dept_total | fmt_hours }}</div>
    <div class="stat-label">Department Total{% if start_str or end_str %} (filtered){% endif %}</div>
  </div>
  <div class="stat-card">
    <div class="stat-value">{{ report_data | length }}</div>
    <div class="stat-label">Employees</div>
  </div>
</div>

{# ── Per-User Breakdown ──────────────────────────────────────── #}
<div class="section">
  <div class="section-header">
    <h2>By Employee</h2>
  </div>

  {% if report_data %}
  <div class="table-container">
    <table class="table">
      <thead>
        <tr>
          <th>Name</th>
          <th class="hide-sm">Email</th>
          <th>Hours</th>
          <th class="hide-sm">Entries</th>
          <th style="width:1%"></th>
        </tr>
      </thead>
      <tbody>
        {% for row in report_data %}
        <tr>
          <td>{{ row.user.name or row.user.email.split('@')[0] }}</td>
          <td class="hide-sm text-muted">{{ row.user.email }}</td>
          <td><strong>{{ row.hours | fmt_hours }}</strong></td>
          <td class="hide-sm text-muted">{{ row.entry_count }}</td>
          <td>
            <a href="{{ url_for('admin.user_report', user_id=row.user.id,
                        start=start_str, end=end_str) }}"
               class="btn btn-xs">Detail</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <td colspan="2"><strong>Total</strong></td>
          <td><strong>{{ dept_total | fmt_hours }}</strong></td>
          <td colspan="2"></td>
        </tr>
      </tfoot>
    </table>
  </div>
  {% else %}
  <div class="empty-state">
    <p>No data found{% if start_str or end_str %} for the selected date range{% endif %}.</p>
  </div>
  {% endif %}
</div>
{% endblock %}
